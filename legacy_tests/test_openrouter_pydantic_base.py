"""
Teste do OpenRouter com PydanticAI usando OpenAIProvider base.
ImplementaÃ§Ã£o compatÃ­vel com versÃµes anteriores do PydanticAI.
"""

import asyncio
import os
from typing import List, Optional

from dotenv import load_dotenv
from pydantic import BaseModel, Field
from pydantic_ai import Agent
from pydantic_ai.models.openai import OpenAIModel
from pydantic_ai.providers.openai import OpenAIProvider

# Carregar variÃ¡veis de ambiente
load_dotenv()


# ===============================
# MODELOS PYDANTIC
# ===============================

class AnaliseJuridica(BaseModel):
    """AnÃ¡lise jurÃ­dica estruturada."""
    
    resumo_principal: str = Field(description="Resumo principal da anÃ¡lise")
    fundamentos_legais: List[str] = Field(description="Principais fundamentos legais")
    jurisprudencia_relevante: List[str] = Field(description="JurisprudÃªncia relevante")
    conclusao: str = Field(description="ConclusÃ£o da anÃ¡lise")
    nivel_confianca: float = Field(ge=0, le=1, description="NÃ­vel de confianÃ§a da anÃ¡lise")
    recomendacoes: List[str] = Field(description="RecomendaÃ§Ãµes prÃ¡ticas")


# ===============================
# CONFIGURAÃ‡ÃƒO DOS MODELOS
# ===============================

def create_openrouter_model(model_name: str) -> OpenAIModel:
    """
    Cria um modelo OpenRouter usando OpenAIProvider base com base_url configurada.
    
    MÃ©todo compatÃ­vel com versÃµes anteriores do PydanticAI.
    """
    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        raise ValueError("OPENROUTER_API_KEY nÃ£o encontrada nas variÃ¡veis de ambiente")
    
    # Usar OpenAIProvider com base_url do OpenRouter
    return OpenAIModel(
        model_name,
        provider=OpenAIProvider(
            base_url='https://openrouter.ai/api/v1',
            api_key=api_key
        )
    )


# ===============================
# AGENTES ESPECIALIZADOS
# ===============================

# Agente com DeepSeek R1 via OpenRouter
deepseek_agent = Agent[None, AnaliseJuridica](
    model=create_openrouter_model('deepseek/deepseek-r1-0528:free'),
    output_type=AnaliseJuridica,
    system_prompt="""
    VocÃª Ã© um especialista em direito brasileiro com foco em anÃ¡lises jurÃ­dicas precisas.
    
    Sua tarefa Ã© fornecer anÃ¡lises jurÃ­dicas estruturadas e fundamentadas, incluindo:
    - Resumo claro da questÃ£o jurÃ­dica
    - Fundamentos legais aplicÃ¡veis
    - JurisprudÃªncia relevante quando disponÃ­vel
    - ConclusÃ£o objetiva
    - RecomendaÃ§Ãµes prÃ¡ticas
    
    Sempre base suas respostas em:
    - ConstituiÃ§Ã£o Federal
    - CÃ³digos (Civil, Penal, Processo Civil, etc.)
    - Leis especÃ­ficas
    - JurisprudÃªncia consolidada dos tribunais superiores
    
    Seja preciso, objetivo e evite especulaÃ§Ãµes sem fundamento legal.
    """
)

# Agente com Gemini 2.0 Flash via OpenRouter
gemini_agent = Agent[None, AnaliseJuridica](
    model=create_openrouter_model('google/gemini-2.0-flash-exp:free'),
    output_type=AnaliseJuridica,
    system_prompt="""
    VocÃª Ã© um especialista em direito brasileiro com experiÃªncia em anÃ¡lises jurÃ­dicas detalhadas.
    
    ForneÃ§a anÃ¡lises jurÃ­dicas completas e bem estruturadas, considerando:
    - Aspectos doutrinÃ¡rios
    - Precedentes jurisprudenciais
    - Impactos prÃ¡ticos
    - Diferentes interpretaÃ§Ãµes possÃ­veis
    
    Mantenha sempre:
    - Rigor tÃ©cnico-jurÃ­dico
    - Linguagem clara e acessÃ­vel
    - FundamentaÃ§Ã£o sÃ³lida
    - ConclusÃµes objetivas
    
    Base suas anÃ¡lises na legislaÃ§Ã£o brasileira vigente e jurisprudÃªncia consolidada.
    """
)


# ===============================
# FUNÃ‡Ã•ES DE TESTE
# ===============================

async def test_deepseek_model():
    """Testa o modelo DeepSeek R1 via OpenRouter."""
    
    print("ğŸ§  Testando DeepSeek R1 via OpenRouter...")
    print("-" * 60)
    
    consulta = """
    Um funcionÃ¡rio foi demitido por justa causa alegando insubordinaÃ§Ã£o, 
    mas ele afirma que apenas questionou uma ordem que poderia ser considerada 
    assÃ©dio moral. Quais os direitos do trabalhador nesta situaÃ§Ã£o e como 
    deve proceder segundo a CLT?
    """
    
    try:
        resultado = await deepseek_agent.run(consulta)
        analise = resultado.output
        
        print(f"ğŸ“Š AnÃ¡lise DeepSeek R1 (ConfianÃ§a: {analise.nivel_confianca:.1%})")
        print(f"ğŸ’­ Resumo: {analise.resumo_principal}")
        print(f"\nğŸ“š Fundamentos Legais:")
        for i, fundamento in enumerate(analise.fundamentos_legais, 1):
            print(f"  {i}. {fundamento}")
        
        print(f"\nâš–ï¸ JurisprudÃªncia:")
        for i, jurisprudencia in enumerate(analise.jurisprudencia_relevante, 1):
            print(f"  {i}. {jurisprudencia}")
        
        print(f"\nâœ… ConclusÃ£o: {analise.conclusao}")
        
        print(f"\nğŸ’¡ RecomendaÃ§Ãµes:")
        for i, recomendacao in enumerate(analise.recomendacoes, 1):
            print(f"  {i}. {recomendacao}")
        
        print(f"\nğŸ“ˆ Tokens utilizados: {resultado.usage()}")
        
        return True
        
    except Exception as e:
        print(f"âŒ Erro no DeepSeek: {e}")
        import traceback
        traceback.print_exc()
        return False


async def test_gemini_model():
    """Testa o modelo Gemini 2.0 Flash via OpenRouter."""
    
    print("\nğŸ¤– Testando Gemini 2.0 Flash via OpenRouter...")
    print("-" * 60)
    
    consulta = """
    Uma empresa deseja implementar trabalho remoto permanente para alguns 
    funcionÃ¡rios. Quais as obrigaÃ§Ãµes legais da empresa em relaÃ§Ã£o a 
    equipamentos, ergonomia, controle de jornada e seguranÃ§a do trabalho 
    segundo a legislaÃ§Ã£o brasileira?
    """
    
    try:
        resultado = await gemini_agent.run(consulta)
        analise = resultado.output
        
        print(f"ğŸ“Š AnÃ¡lise Gemini 2.0 (ConfianÃ§a: {analise.nivel_confianca:.1%})")
        print(f"ğŸ’­ Resumo: {analise.resumo_principal}")
        print(f"\nğŸ“š Fundamentos Legais:")
        for i, fundamento in enumerate(analise.fundamentos_legais, 1):
            print(f"  {i}. {fundamento}")
        
        print(f"\nâš–ï¸ JurisprudÃªncia:")
        for i, jurisprudencia in enumerate(analise.jurisprudencia_relevante, 1):
            print(f"  {i}. {jurisprudencia}")
        
        print(f"\nâœ… ConclusÃ£o: {analise.conclusao}")
        
        print(f"\nğŸ’¡ RecomendaÃ§Ãµes:")
        for i, recomendacao in enumerate(analise.recomendacoes, 1):
            print(f"  {i}. {recomendacao}")
        
        print(f"\nğŸ“ˆ Tokens utilizados: {resultado.usage()}")
        
        return True
        
    except Exception as e:
        print(f"âŒ Erro no Gemini: {e}")
        import traceback
        traceback.print_exc()
        return False


async def test_simple_connection():
    """Teste simples de conexÃ£o."""
    
    print("ğŸ”— Teste simples de conexÃ£o...")
    print("-" * 50)
    
    # Agente simples para teste de conectividade
    simple_agent = Agent[None, str](
        model=create_openrouter_model('deepseek/deepseek-r1-0528:free'),
        system_prompt="Responda de forma breve e direta."
    )
    
    try:
        resultado = await simple_agent.run("Responda apenas 'Sistema funcionando' se conseguir me entender.")
        print(f"âœ… Resposta: {resultado.output}")
        print(f"ğŸ“Š Usage: {resultado.usage()}")
        return True
        
    except Exception as e:
        print(f"âŒ Falha na conexÃ£o: {e}")
        import traceback
        traceback.print_exc()
        return False


async def verify_model_integration():
    """Verifica integraÃ§Ã£o dos modelos no sistema existente."""
    
    print("\nğŸ”§ Verificando integraÃ§Ã£o com sistema existente...")
    print("-" * 60)
    
    try:
        # Importar AgentDependencies existente
        from src.agents.pydantic_agents import AgentDependencies
        from src.models import ProcessingConfig
        
        print("âœ… Classes do sistema existente importadas com sucesso")
        
        # Criar dependencies bÃ¡sicas
        config = ProcessingConfig()
        deps = AgentDependencies(
            config=config,
            session_id="test-session"
        )
        
        print("âœ… DependÃªncias configuradas")
        
        # Teste de integraÃ§Ã£o usando modelo OpenRouter
        integration_agent = Agent[AgentDependencies, str](
            model=create_openrouter_model('deepseek/deepseek-r1-0528:free'),
            system_prompt="VocÃª Ã© um assistente jurÃ­dico especializado."
        )
        
        resultado = await integration_agent.run(
            "Teste de integraÃ§Ã£o: cite apenas um artigo da ConstituiÃ§Ã£o Federal.",
            deps=deps
        )
        
        print(f"âœ… IntegraÃ§Ã£o bem-sucedida: {resultado.output[:100]}...")
        return True
        
    except Exception as e:
        print(f"âŒ Erro na integraÃ§Ã£o: {e}")
        import traceback
        traceback.print_exc()
        return False


# ===============================
# FUNÃ‡ÃƒO PRINCIPAL
# ===============================

async def main():
    """FunÃ§Ã£o principal que executa todos os testes."""
    
    print("ğŸš€ TESTE DO OPENROUTER COM PYDANTIC AI (VERSÃƒO BASE)")
    print("=" * 80)
    print("ğŸ“– Usando OpenAIProvider base com configuraÃ§Ã£o manual do OpenRouter")
    print("ğŸ”— Base URL: https://openrouter.ai/api/v1")
    print("=" * 80)
    
    # Verificar se a API key estÃ¡ configurada
    if not os.getenv("OPENROUTER_API_KEY"):
        print("âŒ ERRO: OPENROUTER_API_KEY nÃ£o configurada!")
        print("ğŸ’¡ Configure a variÃ¡vel de ambiente OPENROUTER_API_KEY")
        print("   Obtenha sua chave em: https://openrouter.ai/keys")
        return
    
    print(f"âœ… API Key configurada: {os.getenv('OPENROUTER_API_KEY')[:20]}...")
    
    # Executar testes
    tests_passed = 0
    total_tests = 4
    
    # 1. Teste simples de conexÃ£o
    if await test_simple_connection():
        tests_passed += 1
    
    # 2. Testar DeepSeek
    if await test_deepseek_model():
        tests_passed += 1
    
    # 3. Testar Gemini
    if await test_gemini_model():
        tests_passed += 1
    
    # 4. Verificar integraÃ§Ã£o
    if await verify_model_integration():
        tests_passed += 1
    
    # Resultado final
    print("\n" + "=" * 80)
    print("ğŸ“Š RESULTADO DOS TESTES")
    print("=" * 80)
    print(f"âœ… Testes aprovados: {tests_passed}/{total_tests}")
    
    if tests_passed == total_tests:
        print("ğŸ‰ Todos os testes passaram! OpenRouter estÃ¡ funcionando perfeitamente com PydanticAI.")
        print("\nğŸ’¡ PRÃ“XIMOS PASSOS:")
        print("  1. Atualize src/agents/pydantic_agents.py para usar esta configuraÃ§Ã£o")
        print("  2. Substitua create_openrouter_model() nos agentes existentes")
        print("  3. Teste com o sistema completo")
        print("  4. Configure monitoramento de uso e custos")
        print("\nğŸ”§ CÃ“DIGO PARA INTEGRAÃ‡ÃƒO:")
        print("```python")
        print("# Em src/agents/pydantic_agents.py, substitua OpenAIModel('gpt-4o') por:")
        print("model = OpenAIModel(")
        print("    'deepseek/deepseek-r1-0528:free',")
        print("    provider=OpenAIProvider(")
        print("        base_url='https://openrouter.ai/api/v1',")
        print("        api_key=os.getenv('OPENROUTER_API_KEY')")
        print("    )")
        print(")")
        print("```")
    else:
        print("âš ï¸  Alguns testes falharam. Verifique:")
        print("  - ConexÃ£o com internet")
        print("  - Validade da API key do OpenRouter")
        print("  - Disponibilidade dos modelos especificados")
        print("  - ConfiguraÃ§Ã£o correta do base_url")


if __name__ == "__main__":
    asyncio.run(main())